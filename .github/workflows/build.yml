name: Build
permissions:
  contents: write
  actions: read
on:
  workflow_call:
    inputs:
      build_mode:
        type: string
        required: false
        default: stable
  workflow_dispatch:
    inputs:
      build_mode:
        description: Build target
        required: false
        default: stable
        type: choice
        options:
        - stable
        - dev
concurrency:
  group: build-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
jobs:
  setup_matrix:
    runs-on: ubuntu-slim
    timeout-minutes: 5
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: Checkout
      uses: actions/checkout@v6.0.2
    - name: Generate Matrix
      id: set-matrix
      run: |
        chmod +x scripts/generate_matrix.sh
        MATRIX=$(./scripts/generate_matrix.sh)
        echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
  apk_matrix:
    needs: setup_matrix
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      actions: read
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup_matrix.outputs.matrix) }}
    steps:
    - name: Checkout
      uses: actions/checkout@v6.0.2
      with:
        fetch-depth: 0
        submodules: true
    - name: Setup build environment
      uses: ./.github/actions/setup-environment
    - name: Cache ReVanced prebuilts
      uses: actions/cache@v5
      with:
        path: ./temp
        key: ${{ runner.os }}-revanced-prebuilts-${{ hashFiles('config.toml') }}
        restore-keys: |
          ${{ runner.os }}-revanced-prebuilts-
    - name: Generate ${{ matrix.id }} config
      run: |
        ./extras.sh separate-config config.toml ${{ matrix.id }} sep_config.toml
        cat sep_config.toml
    - name: Build APKs
      run: ./build.sh sep_config.toml
      env:
        BUILD_MODE: ${{ inputs.build_mode }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEYSTORE_ENTRY_PASSWORD: ${{ secrets.KEYSTORE_ENTRY_PASSWORD }}
    - name: Upload APKs as artifact
      uses: actions/upload-artifact@v7
      with:
        name: apks-${{ matrix.id }}
        path: ./build/*.apk
        if-no-files-found: warn
        retention-days: 1
    - name: Upload build log as artifact
      uses: actions/upload-artifact@v7
      with:
        name: build-log-${{ matrix.id }}
        path: build.md
        if-no-files-found: warn
        retention-days: 1
  release:
    needs: apk_matrix
    if: ${{ needs.apk_matrix.result == 'success' && !cancelled() && github.event_name != 'pull_request' && github.repository == github.event.repository.full_name }}
    runs-on: ubuntu-slim
    timeout-minutes: 15
    permissions:
      contents: write
      actions: read
    steps:
    - name: Checkout
      uses: actions/checkout@v6.0.2
      with:
        fetch-depth: 0
    - name: Check if any artifacts exist
      id: check_artifacts
      continue-on-error: true
      run: |
        if gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts \
          --jq '.artifacts[] | select(.name | startswith("apks-")) | .name' | grep -q .; then
          echo "has_artifacts=true" >> $GITHUB_OUTPUT
        else
          echo "has_artifacts=false" >> $GITHUB_OUTPUT
          exit 1
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Prepare version
      if: steps.check_artifacts.outputs.has_artifacts == 'true'
      id: version
      run: |
        VER=$(date +%y.%m.%d)
        if [ "${{ inputs.build_mode }}" == "dev" ]; then
          VER="${VER}-pre"
        fi
        echo "version=${VER}" >> $GITHUB_OUTPUT
    - name: Download all APKs
      if: steps.check_artifacts.outputs.has_artifacts == 'true'
      uses: actions/download-artifact@v8
      with:
        pattern: apks-*
        path: all-apks
        merge-multiple: true
    - name: Download all build logs
      if: steps.check_artifacts.outputs.has_artifacts == 'true'
      uses: actions/download-artifact@v8
      with:
        pattern: build-log-*
        path: build-logs
    - name: Combine build logs
      if: steps.check_artifacts.outputs.has_artifacts == 'true'
      id: get_output
      run: |
        DELIM="$(openssl rand -hex 8)"
        echo "BUILD_LOG<<${DELIM}" >> "$GITHUB_OUTPUT"
        ./extras.sh combine-logs build-logs >> "$GITHUB_OUTPUT"
        echo "${DELIM}" >> "$GITHUB_OUTPUT"
    - name: Cleanup old releases
      if: steps.check_artifacts.outputs.has_artifacts == 'true'
      continue-on-error: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION_PREFIX="${{ steps.version.outputs.version }}"
        # Extract year-month prefix for cleanup (e.g., "26.03.")
        YM_PREFIX=$(echo "$VERSION_PREFIX" | cut -d. -f1-2)
        # Delete releases from previous months, keep latest 3
        gh release list --json tagName -q ".[].tagName" | \
          grep -v "^${YM_PREFIX}\." | \
          head -n 20 | \
          while read -r tag; do
            echo "Cleaning old release: $tag"
            gh release delete "$tag" -y --cleanup-tag 2>/dev/null || true
          done
    - name: Upload APKs to release
      if: steps.check_artifacts.outputs.has_artifacts == 'true'
      uses: svenstaro/upload-release-action@2.11.4
      with:
        body: ${{ steps.get_output.outputs.BUILD_LOG }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: all-apks/*.apk
        release_name: ${{ steps.version.outputs.version }}
        tag: ${{ steps.version.outputs.version }}
        prerelease: ${{ inputs.build_mode == 'dev' }}
        file_glob: true
        overwrite: true
    - name: Save build state
      if: steps.check_artifacts.outputs.has_artifacts == 'true'
      continue-on-error: true
      run: |
        python3 scripts/version_tracker.py save --config config.toml
    - name: Commit build state
      if: steps.check_artifacts.outputs.has_artifacts == 'true'
      continue-on-error: true
      uses: stefanzweifel/git-auto-commit-action@v7
      with:
        commit_message: "chore: update build versions state [skip ci]"
        file_pattern: .github/last_built_versions.json
